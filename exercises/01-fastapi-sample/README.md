# Technical Interview Exercises - Python FastAPI sample

これは、[株式会社 ABEJA](https://abejainc.com/ja/) の開発者採用面談で利用するコーディングテストの演習問題のひとつです。

## 制限事項

以下の制限事項を守ってください。

1. Python 3.8 以降を使用してください。
2. ライブラリの追加は行わないでください。
3. 提出時には回答結果全てが`submit`という名前のブランチに反映されている状態にしてください。提出後はmainブランチとの差分を確認します。

## アプリケーションについて

このアプリケーションは、ユーザ毎の ToDo タスクを管理する API サンプルです。アプリケーションにはユーザ管理機能が含まれています。

タスクとユーザはそれぞれ以下の情報を持ちます。

- タスク: タイトル、説明、担当ユーザ
- ユーザ: メールアドレス、パスワード、有効(`active`)かどうか

コード内では、タスクは `Items` 、ユーザは `User` として表記されます。

API のエンドポイントと提供する機能は以下です。

| Method | Path                              | 機能                              |
| ------ | --------------------------------- | -------------------------------- |
| `POST` | `/users`                          | ユーザを作成する。                  |
| `GET`  | `/users`                          | ユーザ一覧を取得する。               |
| `GET`  | `/users/:user_id`                 | ユーザ情報を取得する。               |
| `POST` | `/users/:user_id/items`           | あるユーザを担当としてタスクを作成する。|
| `PATCH`| `/users/:user_id/items/:item_id`  | タスクの内容を更新する。             |
| `GET`  | `/items`                          | タスク一覧を取得する。               |
| `GET`  | `/health-check`                   | ヘルスチェック用エンドポイント        |

### 技術スタック

- 本アプリケーションは [FastAPI](https://fastapi.tiangolo.com/) を利用した Web API です。
- 本アプリケーションは [FastAPI の SQL (Relational) Databases サンプル](https://fastapi.tiangolo.com/tutorial/sql-databases/)をベースにしています。テストは [Testing a Database](https://fastapi.tiangolo.com/advanced/testing-database/) をベースにしています。
- 以下のツールを利用しています。
  - パッケージ管理ツール: [Poetry](https://python-poetry.org/)
  - テストフレームワーク: [pytest](https://docs.pytest.org/)
  - Web アプリケーションフレームワーク: [FastAPI](https://fastapi.tiangolo.com/)
  - データベース: [SQLite3](https://www.sqlite.org/index.html)

## アプリケーションの実行

以下の手順で環境構築を行います。

Poetry 1.5.1 を[インストールします](https://python-poetry.org/docs/#installation)。

```bash
$ git clone git@github.com:abeja-inc/system-dev-coding-interview.git
$ cd system-dev-coding-interview/exercises/01-fastapi-sample
$ poetry install
```

以下のコマンドで、アプリケーションをデバッグ実行できます。

```bash
$ make dev
```

## テストの実行

コンテナ環境でのテスト実行を推奨します。以下のコマンドで Docker イメージをビルドします。

```bash
$ make docker-build
```

デフォルトでは Python 3.8 のイメージを作成します。別のバージョンを利用したい場合、環境変数 `PYTHON_VERSION` に任意のバージョンを指定してください。以下は Python 3.11 の例です。

```bash
$ PYTHON_VERSION=3.11 make docker-build
```

イメージのビルド後、以下のコマンドでテストを実行します。

```bash
$ make docker-run
```

コンテナ環境を利用しない場合は以下のコマンドでテストを実行します。

```bash
$ make test
```

## 問題 1: セキュリティと認証


API にユーザ認証機能を実装してください。認証実装後は `X-API-TOKEN` をリクエストヘッダに入れる事でユーザ認証を行う事とします。ただし、ユーザ作成エンドポイント (`POST /users`) は無認証で受け付ける事とします。`X-API-TOKEN` はユーザ作成時に発行し、レスポンスに含めます。
また、変更に伴うテストケースの修正・追加を行ってください。

### 出題意図

この問題の目的は、セキュリティと認証に関する知識と実装能力を評価することです。API のセキュリティ実装に理解を持ち、適切な認証メカニズムを提案・実装できるかどうかを確認します。

- **分類:** セキュリティ
- **背景:** API の開発・利用は頻出する。API でやりとりされるデータを安全に保護するための仕組みについて理解していることが、業務においても重要である


## 問題 2: SQL とインデックス設計によるパフォーマンスチューニング

指定したユーザのタスク一覧を取得するエンドポイントを実装してください。エンドポイントの仕様を以下に示します。実装するにあたり、将来的にデータ量が増えても、著しくパフォーマンスが悪化しないようにしてください。
また、必要なテストケースの追加を行ってください。

### 仕様

- メソッド・パスは `GET /users/:user_id/items`
- クエリパラメータで `date` と `done` を指定できる
  - `date`: `YYYYMMDD` 形式で指定された日付、または未指定。タイムゾーンは JST。このパラメータが指定された場合は、作成日時がその日付のタスク一覧のみに絞る。未指定の場合は絞り込みをしない
  - `done`: `true` または `false` または未指定。`true` であれば完了済み、`false` であれば未完了に絞る。未指定の場合は絞り込みをしない
- 並び順は `date` の降順とする


### 出題意図

この問題の目的は、データベースのパフォーマンスチューニングについて基本的なことを理解しているかを確認する事です。基本的な SQL の書き方に加えて、インデックスについての基礎知識が必要です。面接の場では、データ量が増えた場合の対処方法についても質問することがあります。

- **分類**: SQL とインデックス設計
- **背景**: Web アプリを開発する場合、RDB を扱うことが多いため、基本的なインデックスの設計について知っておく必要がある。また、データ量が増えた場合に、どのような対処が取れるかも知っていると尚良い


## 問題 3: 並列処理とトランザクション

ユーザの削除を行うエンドポイントを追加してください。ユーザの削除は、`is_active` を `False` にする事で行います。
その際、削除対象のユーザが所有する `item` は、有効なユーザかつ `id` が最も小さなユーザの所有権を移す事とします。
また、必要なテストケースの追加を行ってください。

### 出題意図

この問題の主な目的は、トランザクションの考え方と、データの整合性についての理解を評価することです。トランザクションの必要性を理解し、データの整合性を保つためにどのようなアプローチをとるかを確認したいと考えています。また、並列処理を考慮しているかどうかも評価ポイントです。

- **分類**: 並列処理とトランザクション
- **背景**: Web アプリにおいても並列処理が重要になる場面がある。その場合、データベースのトランザクションを適切に実行するなどして、データの不整合を防ぐ必要がある

## 問題 4: クラウド環境での設計

本アプリケーションをクラウド環境(AWS や GCP など)にデプロイするとします。そのときのシステム構成を、具体的なサービス名やコンポーネント名を使って考えてみてください。一次面接の際に質問させていただきます。

### 出題意図

この問題は一般的なクラウドプラットフォーム (AWS, GCP, Azure など) 上での Web アプリケーションの構成と設計についての知識や経験を問う問題です。面接においては、設計において考慮すべきアーキテクチャ特性 (可用性、スケーラビリティ、パフォーマンス、デプロイ容易性、運用 費用など) のトレードオフを鑑みた上で複数の構成案を比較検討できるかを質問します。

- **分類**: クラウド環境での設計
- **背景**: システムを AWS, GCP で構築することが多く、パブリッククラウド上に一般的なシステムを設計・構築できる能力が必要とされる


## 提出方法

`submit.sh` を実行して、テスト実施と提出物作成を行います。

- bashとDockerが実行可能な環境で実行してください。
- 提出内容が全てsubmitブランチに反映されている状態にしてください。提出後はmainブランチとの差分を確認します。
- 未コミットのファイルがある場合はスクリプト実行時にエラーになります。
- テスト実行に失敗した場合はスクリプト実行時にエラーになります。

以下のようにスクリプトを実行して成果物をアーカイブしてください。
```shell
$ bash submit.sh
```

実行後、`submit.zip`というファイルが生成されるので、メールで送付してください。


